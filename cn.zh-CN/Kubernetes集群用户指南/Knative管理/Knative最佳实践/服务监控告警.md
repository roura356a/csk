# 服务监控告警

Knative中可以通过日志服务收集日志信息，同时可以根据日志信息，在日志服务中快速方便的设置监控告警。

-   您已经部署Knative Service服务，请参见[快速部署Serverless应用](/cn.zh-CN/Kubernetes集群用户指南/Knative管理/Knative服务管理/快速部署Serverless应用.md)。
-   您已连接到Kubernetes集群的Master节点，请参见[通过kubectl连接Kubernetes集群](/cn.zh-CN/Kubernetes集群用户指南/集群管理/连接集群/通过kubectl连接Kubernetes集群.md)。

## 操作步骤

1.  设置查询分析。

    请参见[分析简介](/cn.zh-CN/查询与分析/分析简介.md)。

    1.  登录[日志服务管理控制台](http://sls.console.aliyun.com/)，单击目标Project名称，在**日志库**页签的Logstore列表中，可以看到[步骤1](/cn.zh-CN/Kubernetes集群用户指南/Knative管理/Knative最佳实践/在Knative上实现日志采集.md)创建的Logstore。

    2.  单击目标Logstore名称。

    3.  输入如下命令并单击**查询/分析**。

        如果您监控的原则是根据ERROR出现的次数，则设计统计ERROR的SQL语句：

        ![查询分析](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/7995659951/p49472.png)

        ```
        * | select 'ERROR' , count(1) as total group by 'ERROR'
        ```

2.  告警设置。

    请参见[设置告警](/cn.zh-CN/可视化与告警/告警/设置告警.md)。

    1.  单击右上角的**另存为告警**。

        ![创建告警](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/5505163161/p49473.png)

        **说明：** 其中告警触发条件输入判断告警是否触发的条件表达式，可以参见[告警条件表达式语法](/cn.zh-CN/可视化与告警/告警/参考信息/告警条件表达式语法.md)，我们这里设置**查询区间**为1分钟，**执行间隔**为1分钟，**触发条件**为total \> 3， 表示间隔1分钟检查，如果1分钟内出现3次ERROR信息，则触发告警。

    2.  在告警规则面板中填写告警配置信息。

        |配置项|说明|
        |---|--|
        |规则名称|告警规则的名称。名称长度为1~64个字符。|
        |检查频率|服务端每次执行告警检查的时间。 **说明：** 目前服务端每次告警规则检查只会采样处理时间区间开始的前100条数据。 |
        |仪表盘|选择或添加一个仪表盘。|
        |图表名称|图表的名称。名称长度为1~64个字符。|
        |查询语句|SQL查询语句。|
        |查询区间|**查询区间**为服务端每次执行查询时，读取的数据时间范围，支持相对时间与绝对时间。例如，执行时间点为14:30:06，设置**查询区间**为15分钟（相对），则查询区间为14:15:06~14:30:06；设置**查询区间**为15分钟（绝对），则查询区间为：14:15:00~14:30:00。|
        |触发条件|判断告警是否触发的条件表达式，满足该条件时会根据**执行间隔**和**通知间隔**发送告警通知。 例如，您可以设置为`pv%100 > 0 && uv > 0`。

**说明：** 触发条件中，通过`$编号`区分不同的关联图表，例如`$0`表示编号为0的图表。

[如何查看图表编号？](/cn.zh-CN/可视化与告警/告警/参考信息/告警条件表达式语法.md) |
        |触发阈值|累计触发次数达到该阈值时根据**通知间隔**发送告警。不满足触发条件时不计入统计。 默认**触发阈值**为1，即满足一次**触发条件**即可检查**通知间隔**。

通过配置触发通知阈值可以实现多次触发、一次通知。例如，配置触发通知阈值为100，则累计触发次数达到100次时检查**通知间隔**。如果同时满足**触发阈值**和**通知间隔**，则发送通知。发送通知之后，累计次数会清零。如果因网络异常等原因执行检查失败，不计入累计次数。|
        |通知间隔|两次告警通知之间的时间间隔。

如果某次执行满足了触发条件，而且累计的触发次数已经达到**触发通知阈值**，且距离上次发送通知已经达到了通知间隔，则发送通知。如设置通知间隔为5分钟，则5分钟内至多收到一次通知。默认无间隔。

**说明：** 通过配置触发通知阈值和通知间隔可以实现告警抑制的功能，防止收到过多的告警信息。 |
        |通知策略|选择通知方式。可选择短信、语音、邮件、钉钉、WebHook或通知中心。|

    3.  设置通知策略，完成后单击**确定**。

        |通知方式|通知方式|
        |----|----|
        |**短信**|短信形式发送告警通知，需要指定**手机号码**和**发送内容**。

多个手机号码之间通过逗号（，）分隔。**发送内容**为短信通知的内容，支持使用模板变量，长度为1~256个字符。 |
        |**语音**|语音形式发送告警通知，需要指定**手机号码**和**发送内容**。

多个手机号码之间通过逗号（，）分隔。**发送内容**为语音通知的内容，支持使用模板变量，长度为1~500个字符。 |
        |**邮件**|邮件形式发送告警通知，需要指定邮箱地址为**收件人**，并指定**发送内容**。

多个邮箱地址之间通过逗号（，）分隔。**发送内容**为邮件通知的内容，支持使用模板变量，长度为1~500个字符。 |
        |**钉钉**|钉钉机器人消息形式发送告警通知，当触发告警时，告警通知会以钉钉机器人消息的形式发送到钉钉群中。需要指定**请求地址**和**发送内容**。

**发送内容**为钉钉机器人消息的内容，支持使用模板变量，长度为1~500个字符。

如何设置钉钉机器人、获取**请求地址**，请查看[设置告警](/cn.zh-CN/可视化与告警/告警/设置告警.md)。

**说明：** 每个机器人每分钟最多发送20条。 |
        |**WebHook**|当触发告警时，告警通知会以指定形式发送到自定义WebHook地址中。需要指定**请求地址**、**请求方法**和**发送内容**。

**请求方法**可以设置为GET、PUT、POST、DELETE和OPTIONS。**发送内容**为通知的内容，支持使用模板变量，长度为1~500个字符。 |
        |**通知中心**|通过阿里云通知中心中预设的通知方式向联系人发送告警通知。需要指定**发送内容**。**发送内容**为通知消息的内容，支持使用模板变量，长度为1~500个字符。

添加**通知中心**告警方式，需要在通知中心中设置联系人及通知方式。 |

3.  执行如下命令，访问Hello World示例服务。

    此时会触发告警通知。

    ```
    curl -H "Host: helloworld-go.default.example.com" http://112.124.XX.XX
    ```

    ```
    Hello Knative!
    ```

4.  如果是设置的邮件通知，告警信息如下图所示。

    ![邮件通知](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/8995659951/p49475.png)


## 总结

通过结合日志服务的监控告警方式，在Knative中可以第一时间监控到部署应用的异常状态并及时通知给运维、开发人员进行处理，保证服务持续运行。

